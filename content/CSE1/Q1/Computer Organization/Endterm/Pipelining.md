+++
title = "Pipelining"
date = 2019-01-21
+++
<h2>Pipelining</h2><li data-list="bullet"><span class="ql-ui" contenteditable="false"></span><span style="background-color: transparent; color: rgb(0, 0, 0);">Basic idea is executing multiple instructions in parallel for performance gains</span></li><br><li data-list="bullet"><span class="ql-ui" contenteditable="false"></span><strong style="background-color: transparent; color: rgb(0, 0, 0);"><span>Four stage pipeline</span></strong><span style="background-color: transparent; color: rgb(0, 0, 0);">. Divide an instruction into 4 stages so you can execute those stages independently.</span></li><li data-list="bullet" class="ql-indent-1"><span class="ql-ui" contenteditable="false"></span><span style="background-color: transparent; color: rgb(0, 0, 0);">Stages:</span></li><li data-list="bullet" class="ql-indent-2"><span class="ql-ui" contenteditable="false"></span><span style="background-color: transparent; color: rgb(0, 0, 0);">Fetch</span></li><li data-list="bullet" class="ql-indent-2"><span class="ql-ui" contenteditable="false"></span><span style="background-color: transparent; color: rgb(0, 0, 0);">Decode</span></li><li data-list="bullet" class="ql-indent-2"><span class="ql-ui" contenteditable="false"></span><span style="background-color: transparent; color: rgb(0, 0, 0);">Execute</span></li><li data-list="bullet" class="ql-indent-2"><span class="ql-ui" contenteditable="false"></span><span style="background-color: transparent; color: rgb(0, 0, 0);">Write back</span></li><br><li data-list="bullet" class="ql-indent-1"><span class="ql-ui" contenteditable="false"></span><span style="background-color: transparent; color: rgb(0, 0, 0);">Example:</span></li><div style="white-space: normal;" class="markdown-body"><table>
<thead>
<tr>
<th></th>
<th><strong>1</strong></th>
<th><strong>2</strong></th>
<th><strong>3</strong></th>
<th><strong>4</strong></th>
<th><strong>5</strong></th>
<th><strong>6</strong></th>
<th><strong>7</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>I1</strong></td>
<td>F1</td>
<td>D1</td>
<td>E1</td>
<td>W1</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>I2</strong></td>
<td></td>
<td>F2</td>
<td>D2</td>
<td>E2</td>
<td>W2</td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>I3</strong></td>
<td></td>
<td></td>
<td>F3</td>
<td>D3</td>
<td>E3</td>
<td>W3</td>
<td></td>
</tr>
<tr>
<td><strong>I4</strong></td>
<td></td>
<td></td>
<td></td>
<td>F4</td>
<td>D4</td>
<td>E4</td>
<td>W4</td>
</tr>
</tbody>
</table>
</div><li data-list="bullet" class="ql-indent-1"><span class="ql-ui" contenteditable="false"></span><span style="background-color: transparent; color: rgb(0, 0, 0);">As you can see whenever a previous instructions has finished its stage the next one can start it.</span></li><br><li data-list="bullet" class="ql-indent-1"><span class="ql-ui" contenteditable="false"></span><span style="background-color: transparent; color: rgb(0, 0, 0);">To let this work properly you do need to introduce buffers between the stages because otherwise it doesn’t have any way of knowing what to do. Buffers need to store:</span></li><li data-list="bullet" class="ql-indent-2"><span class="ql-ui" contenteditable="false"></span><span style="background-color: transparent; color: rgb(0, 0, 0);">F-&gt;D Instruction</span></li><li data-list="bullet" class="ql-indent-2"><span class="ql-ui" contenteditable="false"></span><span style="background-color: transparent; color: rgb(0, 0, 0);">D-&gt;E Source operands, operation and spec of dest. operand</span></li><li data-list="bullet" class="ql-indent-2"><span class="ql-ui" contenteditable="false"></span><span style="background-color: transparent; color: rgb(0, 0, 0);">E-&gt;W Result and operation and spec of dest. Operand</span></li><br><li data-list="bullet"><span class="ql-ui" contenteditable="false"></span><strong style="background-color: transparent; color: rgb(0, 0, 0);"><span>Stalls</span></strong><span style="background-color: transparent; color: rgb(0, 0, 0);">. Stages don’t always take exactly one cycle and this causes the pipeline to stall.</span></li><li data-list="bullet" class="ql-indent-1"><span class="ql-ui" contenteditable="false"></span><span style="background-color: transparent; color: rgb(0, 0, 0);">Causes (Stage in brackets):</span></li><li data-list="bullet" class="ql-indent-2"><span class="ql-ui" contenteditable="false"></span><span style="background-color: transparent; color: rgb(0, 0, 0);">Cache miss (F, D)</span></li><li data-list="bullet" class="ql-indent-2"><span class="ql-ui" contenteditable="false"></span><span style="background-color: transparent; color: rgb(0, 0, 0);">Dependency (D)</span></li><li data-list="bullet" class="ql-indent-2"><span class="ql-ui" contenteditable="false"></span><span style="background-color: transparent; color: rgb(0, 0, 0);">Branching (E)</span></li><li data-list="bullet" class="ql-indent-2"><span class="ql-ui" contenteditable="false"></span><span style="background-color: transparent; color: rgb(0, 0, 0);">Difficult/Long op. (E)</span></li><br><li data-list="bullet" class="ql-indent-1"><span class="ql-ui" contenteditable="false"></span><span style="background-color: transparent; color: rgb(0, 0, 0);">Pipeline stalls due to data dependencies can be alleviated through the use of </span><strong style="background-color: transparent; color: rgb(0, 0, 0);"><span>operand forwarding</span></strong><span style="background-color: transparent; color: rgb(0, 0, 0);">. If a stage stalls the hardware can forward data needed in future instructions so that not everything needs to stall.</span></li><br><li data-list="bullet" class="ql-indent-1"><span class="ql-ui" contenteditable="false"></span><strong style="background-color: transparent; color: rgb(0, 0, 0);"><span>Branch prediction</span></strong><span style="background-color: transparent; color: rgb(0, 0, 0);">. For unconditional branches the target is known after decoding and the penalty can be reduced to one cycle.</span></li><li data-list="bullet" class="ql-indent-2"><span class="ql-ui" contenteditable="false"></span><strong style="background-color: transparent; color: rgb(0, 0, 0);"><span>Static prediction</span></strong><span style="background-color: transparent; color: rgb(0, 0, 0);">: Backwards branches are taken often (loops) but forward branches not</span></li><li data-list="bullet" class="ql-indent-2"><span class="ql-ui" contenteditable="false"></span><strong style="background-color: transparent; color: rgb(0, 0, 0);"><span>Dynamic prediction</span></strong><span style="background-color: transparent; color: rgb(0, 0, 0);">: Maintain info about branches (target) and repeat it</span></li><li data-list="bullet" class="ql-indent-2"><span class="ql-ui" contenteditable="false"></span>A <strong>branch target buffer </strong><span>can be used to keep information about the history of execution. This buffer identifies branch instructions by their addresses and thus branch prediction can be even more efficient.</span></li><br><li data-list="bullet" class="ql-indent-1"><span class="ql-ui" contenteditable="false"></span><strong>Branch Delay Slot: </strong><span>The location that follows a branch instruction, this instruction will always be executed. On this way, the branch doesn't have to wait for this instruction to finish and thus this saves a cycle. The instruction is executed directly after the branch is or is not taken, and thus it seems like the branch is actually delayed: </span><strong><span>delayed branching. </span></strong><span>(Read 6.6.3 for a better explanation)</span></li><br><li data-list="bullet"><span class="ql-ui" contenteditable="false"></span><span style="background-color: transparent; color: rgb(0, 0, 0);">Performance model:</span></li><li data-list="bullet" class="ql-indent-1"><span class="ql-ui" contenteditable="false"></span><span style="background-color: transparent; color: rgb(0, 0, 0);"><span class="ql-formula" data-value="T">﻿<span contenteditable="false"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>T</mi></mrow><annotation encoding="application/x-tex">T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.68333em; vertical-align: 0em;"></span><span style="margin-right: 0.13889em;" class="mord mathdefault">T</span></span></span></span></span>﻿</span>  = Execution time of a program</span></li><li data-list="bullet" class="ql-indent-1"><span class="ql-ui" contenteditable="false"></span><span style="background-color: transparent; color: rgb(0, 0, 0);"><span class="ql-formula" data-value="N">﻿<span contenteditable="false"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.68333em; vertical-align: 0em;"></span><span style="margin-right: 0.10903em;" class="mord mathdefault">N</span></span></span></span></span>﻿</span> = Instruction count</span></li><li data-list="bullet" class="ql-indent-1"><span class="ql-ui" contenteditable="false"></span><span style="background-color: transparent; color: rgb(0, 0, 0);"><span class="ql-formula" data-value="S">﻿<span contenteditable="false"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.68333em; vertical-align: 0em;"></span><span style="margin-right: 0.05764em;" class="mord mathdefault">S</span></span></span></span></span>﻿</span> = # Cycles per instruction, CPI:</span></li><li data-list="bullet" class="ql-indent-1"><span class="ql-ui" contenteditable="false"></span><span style="background-color: transparent; color: rgb(0, 0, 0);"><span class="ql-formula" data-value="R">﻿<span contenteditable="false"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>R</mi></mrow><annotation encoding="application/x-tex">R</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.68333em; vertical-align: 0em;"></span><span style="margin-right: 0.00773em;" class="mord mathdefault">R</span></span></span></span></span>﻿</span> = Clock rate</span></li><li data-list="bullet" class="ql-indent-1"><span class="ql-ui" contenteditable="false"></span><span style="background-color: transparent; color: rgb(0, 0, 0);">Without pipelining: </span><span style="background-color: transparent; color: rgb(0, 0, 0);"><span class="ql-formula" data-value="T=\frac{\left(N\times S\right)}{R}">﻿<span contenteditable="false"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>T</mi><mo>=</mo><mfrac><mrow><mo fence="true">(</mo><mi>N</mi><mo>×</mo><mi>S</mi><mo fence="true">)</mo></mrow><mi>R</mi></mfrac></mrow><annotation encoding="application/x-tex">T=\frac{\left(N\times S\right)}{R}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.68333em; vertical-align: 0em;"></span><span style="margin-right: 0.13889em;" class="mord mathdefault">T</span><span class="mspace" style="margin-right: 0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height: 1.355em; vertical-align: -0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.01em;"><span class="" style="top: -2.6550000000000002em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span style="margin-right: 0.00773em;" class="mord mathdefault mtight">R</span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.485em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="minner mtight"><span class="mopen mtight delimcenter" style="top: 0em;"><span class="mtight">(</span></span><span style="margin-right: 0.10903em;" class="mord mathdefault mtight">N</span><span class="mbin mtight">×</span><span style="margin-right: 0.05764em;" class="mord mathdefault mtight">S</span><span class="mclose mtight delimcenter" style="top: 0em;"><span class="mtight">)</span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.345em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span>﻿</span></span></li><li data-list="bullet" class="ql-indent-1"><span class="ql-ui" contenteditable="false"></span><span style="background-color: transparent; color: rgb(0, 0, 0);">With an </span><span style="background-color: transparent; color: rgb(0, 0, 0);"><span class="ql-formula" data-value="n">﻿<span contenteditable="false"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.43056em; vertical-align: 0em;"></span><span class="mord mathdefault">n</span></span></span></span></span>﻿</span>-stage pipeling: </span><span style="background-color: transparent; color: rgb(0, 0, 0);"><span class="ql-formula" data-value="T'=\frac{T}{n}">﻿<span contenteditable="false"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mi>T</mi><mo mathvariant="normal">′</mo></msup><mo>=</mo><mfrac><mi>T</mi><mi>n</mi></mfrac></mrow><annotation encoding="application/x-tex">T&amp;#x27;=\frac{T}{n}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.751892em; vertical-align: 0em;"></span><span class="mord"><span style="margin-right: 0.13889em;" class="mord mathdefault">T</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.751892em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height: 1.217331em; vertical-align: -0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.872331em;"><span class="" style="top: -2.6550000000000002em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.394em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span style="margin-right: 0.13889em;" class="mord mathdefault mtight">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.345em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span>﻿</span></span></li><li data-list="bullet" class="ql-indent-2"><span class="ql-ui" contenteditable="false"></span><span style="background-color: transparent; color: rgb(0, 0, 0);">But </span><span style="background-color: transparent; color: rgb(0, 0, 0);"><span class="ql-formula" data-value="S">﻿<span contenteditable="false"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.68333em; vertical-align: 0em;"></span><span style="margin-right: 0.05764em;" class="mord mathdefault">S</span></span></span></span></span>﻿</span>  increases due to stalls</span></li><br>